version: '3.8'

services:
  # Caddy Reverse Proxy
  caddy:
    image: caddy:2.7-alpine
    container_name: caddy-dev
    restart: unless-stopped
    ports:
      - '8080:8080' # HTTP port for development
      - '2019:2019' # Caddy admin API
    volumes:
      # Development Caddyfile
      - ./caddy/config/Caddyfile.dev:/etc/caddy/Caddyfile:ro
      # Persistent data (certificates, cache)
      - ./caddy/data:/data
      # Configuration storage
      - ./caddy/config:/config
      # Logs
      - ./caddy/logs:/var/log/caddy
    networks:
      - caddy-network
    depends_on:
      - backend-1
      - backend-2
      - backend-3
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:2019/config/']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Backend Instance 1
  backend-1:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: backend-1
    restart: unless-stopped
    expose:
      - '4001'
    environment:
      - NODE_ENV=production
      - PORT=4001
      - INSTANCE_ID=backend-1
      - TRUSTED_PROXY=caddy
      - API_TYPE=both
      - DB_TYPE=${DB_TYPE:-postgres}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres-caddy:5432/${POSTGRES_DB:-todoapp}?schema=public
      - MONGODB_URL=mongodb://${MONGO_USER:-admin}:${MONGO_PASSWORD:-admin}@mongodb-caddy:27017/${MONGO_DB:-todoapp}?authSource=admin
      - REDIS_URL=redis://redis-caddy:6379
      # JWT secrets
      - JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - JWT_ACCESS_EXPIRY=${JWT_ACCESS_EXPIRY:-15m}
      - JWT_REFRESH_EXPIRY=${JWT_REFRESH_EXPIRY:-7d}
      # Session
      - SESSION_TIMEOUT_MINUTES=${SESSION_TIMEOUT_MINUTES:-5}
      - SESSION_LIFETIME_HOURS=${SESSION_LIFETIME_HOURS:-168}
      - MAX_SESSIONS_PER_USER=${MAX_SESSIONS_PER_USER:-5}
      # CORS
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:8080}
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}
    networks:
      - caddy-network
    depends_on:
      postgres:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:4001/health']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # Backend Instance 2
  backend-2:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: backend-2
    restart: unless-stopped
    expose:
      - '4002'
    environment:
      - NODE_ENV=production
      - PORT=4002
      - INSTANCE_ID=backend-2
      - TRUSTED_PROXY=caddy
      - API_TYPE=both
      - DB_TYPE=${DB_TYPE:-postgres}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres-caddy:5432/${POSTGRES_DB:-todoapp}?schema=public
      - MONGODB_URL=mongodb://${MONGO_USER:-admin}:${MONGO_PASSWORD:-admin}@mongodb-caddy:27017/${MONGO_DB:-todoapp}?authSource=admin
      - REDIS_URL=redis://redis-caddy:6379
      # JWT secrets
      - JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - JWT_ACCESS_EXPIRY=${JWT_ACCESS_EXPIRY:-15m}
      - JWT_REFRESH_EXPIRY=${JWT_REFRESH_EXPIRY:-7d}
      # Session
      - SESSION_TIMEOUT_MINUTES=${SESSION_TIMEOUT_MINUTES:-5}
      - SESSION_LIFETIME_HOURS=${SESSION_LIFETIME_HOURS:-168}
      - MAX_SESSIONS_PER_USER=${MAX_SESSIONS_PER_USER:-5}
      # CORS
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:8080}
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}
    networks:
      - caddy-network
    depends_on:
      postgres:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:4002/health']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # Backend Instance 3
  backend-3:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: backend-3
    restart: unless-stopped
    expose:
      - '4003'
    environment:
      - NODE_ENV=production
      - PORT=4003
      - INSTANCE_ID=backend-3
      - TRUSTED_PROXY=caddy
      - API_TYPE=both
      - DB_TYPE=${DB_TYPE:-postgres}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres-caddy:5432/${POSTGRES_DB:-todoapp}?schema=public
      - MONGODB_URL=mongodb://${MONGO_USER:-admin}:${MONGO_PASSWORD:-admin}@mongodb-caddy:27017/${MONGO_DB:-todoapp}?authSource=admin
      - REDIS_URL=redis://redis-caddy:6379
      # JWT secrets
      - JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - JWT_ACCESS_EXPIRY=${JWT_ACCESS_EXPIRY:-15m}
      - JWT_REFRESH_EXPIRY=${JWT_REFRESH_EXPIRY:-7d}
      # Session
      - SESSION_TIMEOUT_MINUTES=${SESSION_TIMEOUT_MINUTES:-5}
      - SESSION_LIFETIME_HOURS=${SESSION_LIFETIME_HOURS:-168}
      - MAX_SESSIONS_PER_USER=${MAX_SESSIONS_PER_USER:-5}
      # CORS
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:8080}
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}
    networks:
      - caddy-network
    depends_on:
      postgres:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:4003/health']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: postgres-caddy
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-todoapp}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - caddy-network
    ports:
      - '5432:5432'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-todoapp}']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # MongoDB Database
  mongodb:
    image: mongo:7-jammy
    container_name: mongodb-caddy
    restart: unless-stopped
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_USER:-admin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASSWORD:-admin}
      - MONGO_INITDB_DATABASE=${MONGO_DB:-todoapp}
    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
    networks:
      caddy-network:
        aliases:
          - mongo-dev
    expose:
      - '27017'
    healthcheck:
      test: ['CMD', 'mongosh', '--eval', "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Redis - For Socket.IO adapter (cross-instance communication)
  redis:
    image: redis:7-alpine
    container_name: redis-caddy
    restart: unless-stopped
    networks:
      - caddy-network
    expose:
      - '6379'
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  # Prometheus - Metrics Collection & Monitoring
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: prometheus-dev
    restart: unless-stopped
    ports:
      - '9090:9090' # Prometheus UI
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle' # Enable reload via /-/reload endpoint
      - '--storage.tsdb.retention.time=30d' # Keep 30 days of data
    networks:
      - caddy-network
    depends_on:
      - backend-1
      - backend-2
      - backend-3
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:9090/-/healthy']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Grafana - Visualization & Dashboards
  grafana:
    image: grafana/grafana:10.2.2
    container_name: grafana-dev
    restart: unless-stopped
    ports:
      - '3000:3000' # Grafana UI
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    networks:
      - caddy-network
    depends_on:
      - prometheus
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:3000/api/health']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  caddy-network:
    driver: bridge
    name: caddy-network

volumes:
  postgres-data:
    name: caddy-postgres-data
  mongodb-data:
    name: caddy-mongodb-data
  mongodb-config:
    name: caddy-mongodb-config
  prometheus-data:
    name: caddy-prometheus-data
  grafana-data:
    name: caddy-grafana-data
